<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>我参与的</title>
		<link rel="stylesheet" type="text/css" href="../../resources/css/bootstrap.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../resources/css/base.css"/>
		<link rel="stylesheet" type="text/css" href="../css/index.css"/>
		<link rel="stylesheet" type="text/css" href="../../../moduleweb/resources/layui/css/layui.css" />
		<style>
			.td-omit{
				width: 23%;
			}
			.omit{
				width: 200px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			.layui-layer-content{
				color: #ffffff;
				background:rgba(0,0,0,0.5);
				margin: 0;
				padding: 0;
				border-radius: 4px;
			}
			.layui-layer.layui-layer-dialog.layui-layer-border.layui-layer-msg.layer-anim{
				background-color: transparent;
				border:none;
			}
		</style>
	</head>
	<body>
		<aside>
			<img src="../img/nonews.png"/>
		</aside>
		<nav class="header">
			<ol class="breadcrumb">
			  <li><a href="javascript:;">中心组学习</a></li>
			  <li class="active cursor">我参与的</li>
			</ol>
		</nav>
		<article>
			<nav>
				<ul class="clear">
					<li class="left cursor active">我参与的</li>
				</ul>
			</nav>
			<section>
				<label for="">学习标题：</label>
				<input type="text" class="form-control widthMin verticalalignTop joinmeettitle" placeholder="请输入" />
				<label for="">状态</label>
				<select class="selectlist form-control meetStatelist widthMax verticalalignTop">
					<option value="">全部</option>
					<option value="0,1">未开始</option>
					<option value="2">进行中</option>
					<option value="3,4,5">已结束</option>
					<option value="-1">已取消</option>
				</select>
				<button class="btnbg" onclick="classify()">查询</button>
				<button class="btnbg" onclick="clearall()">重置</button>
			</section>
			<section>
				<table class="table table-striped tableNoBor">
					<tr>
						<th>学习标题</th>
						<th>学习开始时间</th>
						<th>学习地点</th>
						<th>会议类型</th>
						<th>状态</th>
						<th>操作</th>
					</tr>
					<tbody class="joinmeetlist">
						<tr class="joinmeetingitem">
							<td class="td-omit"><p class="omit meetingtitle cursor" onclick="godetail(this)"></p></td>
							<td class="meetingtime"></td>
							<td class="td-omit"><p class="omit meetingsate"></p></td>
							<td class="meetingname"></td>
							<td class="meetstateText"></td>
							<td class="caozuo"><a href="javascript:;" class="leaveitem" onclick="gocaozuoFU(this)"></a></td>
						</tr>
					</tbody>
				</table>
			</section>
			<section>
				<div id="joinpage"></div>
			</section>
		</article>
		<div class="alertBox alertBox1">
			<div class="alert">
				<div class="header">
					<p class="ellipsis">请假</p>
					<img class="closeAlert" src="../img/close.png"/>
				</div>
				<div class="alert_content">
					您确认要请假吗？如果请假后需要取消请假，请与中心组负责人联系，恢复请假信息。
				</div>
				<div class="alert_footer">
					<button class="btnbg sure" onclick="goleaveFUN(this)">确定</button>
					<button class="btn btn-default cancel">取消</button>
				</div>
			</div>
		</div>
		<div class="alertBox alertBox1_1">
			<div class="alert">
				<div class="header">
					<p class="ellipsis">请假</p>
					<img class="closeAlert" src="../img/close.png"/>
				</div>
				<div class="alert_content row">
					<form class="form-horizontal col-xs-12">
						<div class="form-group col-xs-6">
							<label  class="col-xs-4 control-label"><span class="red">*</span>姓名：</label>
							<div class="col-xs-8">
								<input type="text" class="form-control username" placeholder="请输入" readonly/>
							</div>
					  	</div>
					  	<div class="form-group col-xs-6">
							<label  class="col-xs-4 control-label"><span class="red">*</span>所属支部：</label>
							<div class="col-xs-8">
								<input type="text" class="form-control usersection" placeholder="请输入" readonly/>
							</div>
					  	</div>
					  	<div class="form-group col-xs-12">
							<label style="padding: 0;"  class="col-xs-2 control-label"><span class="red">*</span>请假事由：</label>
							<div class="col-xs-10" style="padding: 0;">
								<textarea rows="4" cols="" class="form-control leavecontent" placeholder="请输入"></textarea>
							</div>
					  	</div>
					</form>
				</div>
				<div class="alert_footer">
					<button class="btnbg sure" onclick="upleaveFU(this)">确定</button>
					<button class="btn btn-default cancel">取消</button>
				</div>
			</div>
		</div>
		<div class="alertBox2">
			<div class="alert2">
				<div class="header">
					<p class="ellipsis">学习笔记</p>
					<img class="closeAlert2" src="../img/close.png"/>
				</div>
				<div class="alert_content">
					如果您确认完成学习笔记点击确定按钮，没有完成点击取消按钮，确认后默认您完成了学习笔记？
				</div>
				<div class="alert_footer">
					<button class="btnbg sure" onclick="gonoteFUN(this)">确定</button>
					<button class="btn btn-default cancel">取消</button>
				</div>
			</div>
		</div>
	</body>
</html>
<script type="text/javascript" src="../../../r/wx/common/pathimage"></script>
<script src="../../../moduleweb/resources/js/jquery-3.1.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../resources/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="../../resources/plugins/ztree/jquery.ztree.core.min.js"></script>
<script src="../../layui/layui.all.js"></script>
<script src="../js/alert.js"></script>
<script src="../js/ajax.js"></script>
<script type="text/javascript">
	function joinlisterFUN() {
        $(".alertBox2 .closeAlert2,.alertBox2 .cancel,.alertBox2 .sure").off("click").on("click",function(){
            $(".alertBox2").fadeOut();
        });
        $(".alertBox1 .closeAlert,.alertBox1 .cancel,.alertBox1 .sure").off("click").on("click",function(){
            $(".alertBox1").fadeOut();
        });
        $(".alertBox1_1 .closeAlert,.alertBox1_1 .cancel,.alertBox1_1 .sure").off("click").on("click",function(){
            $(".alertBox1_1").fadeOut();
        });
    }
</script>
<script type="text/javascript">
    //我的参与
    var meetState = "";
    var meetType = "";
    var signstate = "";
    var meettitle = "";
    var pagea = 1; //开始页数
    var sizea = 20; //每页最多显示条数
    var nowpagea = 1; //当前页数
    var pagesa = 0;
    var  leaveitem = $(".leaveitem");
    leaveitem.remove();
    var joinmeetingitem = $(".joinmeetingitem");
    joinmeetingitem.remove();
    $(function() {
        joinFindpage()
    })
    function classify() {
        meetState = $(".meetStatelist option:selected").val();
        meetType = $(".joinmeettypelist option:selected").val();
        signstate = $(".signlist option:selected").val();
        meettitle = $(".joinmeettitle").val();
        joinFindpage()
    }

    function clearall() {
        $(".meetStatelist").val("");
        $(".joinmeettypelist").val("");
        $(".signlist").val("");
        $(".joinmeettitle").val("");
        meetState = $(".meetStatelist option:selected").val();
        meetType = $(".joinmeettypelist option:selected").val();
        signstate = $(".signlist option:selected").val();
        meettitle = $(".joinmeettitle").val();
        joinFindpage()
    }
	function goleaveFUN(that) {
        $(".alertBox1_1").fadeIn();
        $(".alertBox1_1 .sure").attr("id", $(that).attr("id"));
    }
    function upleaveFU(that){
        var leaveid = $(that).attr("id");
        var stydytitle = $("#"+leaveid).find(".meetingtitle").text();
        var userName = $(".alertBox1_1 .username").val();
        var bumenName = $(".alertBox1_1 .usersection").val();
        var leavecontent = $(".alertBox1_1 .leavecontent").val();
        $.post(_ctxPath + "conference/detail/userLeave.action", {
            "detailId": leaveid,
            "title": stydytitle,
            "userName": userName,
            "bumenName": bumenName,
            "content": leavecontent
        }, function(data) {
            if (data.success) {
                layer.msg("提交请假成功");
                joinFindpage()
                $(".alertBox1_1 .leavecontent").val("");

            } else{
                layer.msg(data.message);
            }
        })
	}
    function meetstateFun(state) {
        var test = {};
        if (state == "0" || state == "1") {
            test["txt"] = '未开始';
            test["color"] = "#40A9FF";
        } else if (state == "2") {
            test["txt"] = '进行中';
            test["color"] = "#40A9FF";
        } else if (state == "3" || state == "4" || state == "5") {
            test["txt"] = '已结束';
            test["color"] = "#73D13D";
        } else if (state == "-1") {
            test["txt"] = '已取消';
            test["color"] = "#F5222D";
        }
        return JSON.stringify(test);
    };
    //函数
    function pagepeozhi1() {
        layui.use(['laypage', 'layer'], function() {
            var laypage = layui.laypage,
                layer = layui.layer;
            laypage.render({
                elem: 'joinpage',
                count: pagesa,
                curr: nowpagea,
                limit: sizea,
                layout: ['count', 'prev', 'page', 'next', 'skip'],
                jump: function(obj, first) {
                    nowpagea = obj.curr;
                    pagea = (obj.curr - 1) * sizea;
                    if (!first) { //一定要加此判断，否则初始时会无限刷新
                        joinFindpage(); //一定要把翻页的ajax请求放到这里，不然会请求两次。
                        location.href = '#top';
                        //<a href="#top">返回顶部</a>
                    }
                }
            });
        });
    }

    function joinFindpage() {
        $(".joinmeetlist").html("");
        $.get(_ctxPath + "conference/detail/query.action", {
            "regex:conference.title": meettitle,
            "page": nowpagea, //当前页数
            "size": sizea,
            "in:conference.state|array-integer": meetState,
            "in:state|array-integer": signstate,
            "conference.meetType": meetType,
            "in:conference.type|array-integer": "301,302"
        }, function(data) {
            pagea = data.data.page; //当前页数(后台返回)
            pagesa = data.data.total;
            var myjoinArr = data.data.data;
            var usermsg = data.entity;
            $(".alertBox1_1").find(".username").val(usermsg.name);
            $(".alertBox1_1").find(".usersection").val(usermsg.bumenName);
            if (myjoinArr.length > 0) {
                $(myjoinArr).each(function() {
                    var item = joinmeetingitem.clone().css("display", "").attr("id",this._id);
                    item.find(".meetingtitle").text(this.conference.title).attr("id",this._id);
                    item.find(".meetingname").text(this.conference.meetTypeName);
                    item.find(".meetingtime").text(this.conference.formatAttendtime);
                    item.find(".meetingsate").text(this.conference.address);
                    var meetobj = JSON.parse(meetstateFun(this.conference.state));
                    item.find(".meetstateText").text(meetobj.txt);
                    if((this.conference.state=="3"||this.conference.state=="4"||this.conference.state=="5")&&this.state=="2"){
                     	if(this.subNote=="0"){
                            var note = leaveitem.clone();
                            note.text("确认完成学习笔记").attr("id", this._id);;
                            item.find(".caozuo").append(note);
						}
					} else{
                        var signmeetTEXT = signmeetFun(this.conference.state, this.state);
                        var leave = leaveitem.clone();
                        leave.text(signmeetTEXT).attr("id",this._id);
                        item.find(".caozuo").append(leave);
					}
                    $(".joinmeetlist").append(item);
                })
            }
            pagepeozhi1();
            joinlisterFUN();
        })
    };

    /**
     *
     * @param {Object} st1 会议状态
     * @param {Object} st2 用户参会状态
     */
    function signmeetFun(st1, st2) {
        var txt = "";
        if (st1 == "0" || st1 == "1") {
            txt = "请假";
        }
        if (st2 == "6") {
            txt = "待审核";
        } else if (st2 == "4") {
            txt = "请假获批"
        } else if (st2 == "7") {
            txt = "请假驳回"
        }
        return txt;
    }
    function godetail(that) {
        var changeid = $(that).attr("id")
            window.location.href = "joindetail.html?id=" + changeid;
    }
    function gocaozuoFU(that){
        var caozuoid = $(that).attr("id");
		if ($(that).text() == "请假") {
			$(".alertBox1").fadeIn();
			$(".alertBox1 .sure").attr("id",caozuoid);
		} else if ($(that).text() == "待审核"||$(that).text() == "请假获批"||$(that).text() == "请假驳回") {
            window.location.href = "leavedetail.html?id=" + caozuoid
		}else if ($(that).text() == "确认完成学习笔记") {
            $(".alertBox2").fadeIn();
            $(".alertBox2").find(".sure").attr("id",caozuoid)

        }

	}
	function gonoteFUN(that){
        var noteid = $(that).attr("id")
        $.get(_ctxPath + "conference/detail/subNote.action", {"detailId":noteid},function(data){
           if (data.success) {
                layer.msg("确认完成笔记成功");
                joinFindpage()
            } else{
                alertFun(data.message)
            }
        })
	}
</script>